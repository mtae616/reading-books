# 데이터 압축

- 디스크에 데이터 파일이 크면 클 수록 cost 가 높다.
- 이를 위해 데이터 압축 기능을 제공

## 데이터 압축

- Transparent Page Compression
- 데이터 페이지가 압축되어 저장
    - 디스크에서 데이터 페이지를 읽어올 때 압축 해제
- 버퍼 풀에 데이터 페이지가 한 번 적재되면 압축이 해제된 상태로만 데이터 페이지 관리
- 그래서 MySQL 서버의 내부 코드에서는 압축 여부와 관계 없이 Transparent 하게 작동됨
- 만약 페이지 크기 보다 작게 압축되면 패딩 넣음

```sql
1. 16KB 페이지를 압축 (압축 결과 7KB)
2. MySQL 서버는 디스크에 압축된 결과 7KB 기록
(이때 MySQL 서버는 압축 데이터 7KB + 9KB 빈 데이터 기록)
3. 디스크에 데이터를 기록한 후 7KB 이후의 공간 9KB 대해 펀치홀 생성
4. 파일 시스템은 7KB 만 남기고 나머지 디스크의 공간은 다시 운영체제로 반납
```

- 실제 디스크에는 7KB 만 차지하지만 운영체제에서 16KB 를 읽으면 압축된 데이터 7KB 와 홀 공간인 9KB 를 합쳐서 16KB 를 읽는다.
- 다만 하드웨어에서 지원해야 하고, 실제 펀치홀을 적용하면 원본크기가 되는 경우가 있어 잘 쓰지 않음

## 테이블 압축

- 테이블 압축은 운영체제나 하드웨어 제약 없이 사용하여 활용도 높음
- 단점
    - 버퍼 풀 공간 활용률이 낮음
    - 쿼리 처리 성능이 낮음
    - 빈번한 데이터 변경 시 압축률이 떨어짐

### 압축 테이블 생성

- 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 사용해야 한다.
- `innodb_file_per_table` 이 활성화 되어 있어야 한다.
    - ROW_FORMAT=COMPRESSED 옵션도 활성화 해야 한다.
    - KEY_BLOCK_SIZE 옵션을 통해 압축된 페이지의 타겟 크기를 명시
        - 2n 으로만 설정할 수 있다.
        - 만약 페이지 크기가 16KB 라면 4KB 또는 8KB 로만 설정
        - 페이지 크기가 32KB 또는 64KB 인 경우 테이블 압축 적용할 수 없다.

```sql
1. 16KB 의 데이터 페이지를 압축
	1.1. 압축된 결과가 8kb 이하이면 그대로 디스크에 저장
	1.2. 압축된 결과가 8kb 를 초과하면 원본 페이지를 split 해서 2개의 페이지에 8kb 씩 저장
2. 나뉜 페이지 각각에 대해 1번 단계를 반복 실행
```

### KEY_BLOCK_SIZE 결정

- 압축된 결과가 어느 정도가 될지를 예측해서 KEY_BLOCK_SIZE 결정
- 압축을 실행해서 실패율이 3 ~ 5 % 미만으로 유지할 수 있게 KEY_BLOCK_SIZE 설정
    - 실패율이 높다고 압축을 사용하지 말아야 한다는 것을 의미하지는 않는다.

### 압축된 페이지의 버퍼 풀 적재 및 사용

- 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면 압축된 상태와 압축이 해제된 상태 2개 버전을 관리
    - InnoDB 스토리지 엔진은 디스크에서 읽은 상태 그대로 데이터 페이지의 목록을 관리하는 LRU 리스트와
        - 압축이 적용되지 않은 테이블의 데이터 페이지
        - 압축이 적용된 테이블의 압축된 데이터 페이지 둘 다 가진다.
    - 압축된 페이지들의 압축 해제 버전인 Unzip_LRU 리스트를 별도로 관리
- 따라서 리스트를 이중으로 관리하며 메모리 낭비…
- 압축 해제 작업은 CPU 를 많이 소모하는 작업…
- 따라서 Unzip_LRU 리스트를 별도로 관리하고 있다가
    - 버퍼 풀이 공간이 필요할 경우 Unzip_LRU 리스트에서 압축 해제된 버전은 제거
    - 압축된 데이터 페이지가 자주 사용되는 경우 Unzip_LRU 리스트에 압축 해제된 페이지를 계속 유지하면서 압축 및 압축 해제 작업을 최소화
    - 압축된 데이터 페이지가 사용되지 않아서 LRU 리스트에서 제거되는 경우에는 Unzip_LRU 리스트에서도 함께 제거
- InnoDB 스토리지 엔진은 버퍼 풀에서 압축 해제된 버전의 데이터 페이지를 적절히 유지하기 위해 다음과 같은 알고리즘을 사용
    - CPU 사용량이 높은 서버에서는 가능하면 압축과 압축 해제를 피하기 위해 Unzip_LRU 비율을 높임
    - Disk IO 사용량이 높은 서버에서는 가능하면 Unzip_LRU 리스트 비율을 낮춰서 InnoDB 버퍼 풀의 공간을 더 확보하도록 작동