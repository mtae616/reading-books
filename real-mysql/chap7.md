# 데이터 암호화

- 대상
    - 데이터 파일
    - 리두 로그
    - 언두 로그
    - 복제를 위한 바이너리 로그
- 응용 프로그램의 암호화는 중요 정보를 가진 칼럼 단위 암호화
- 데이터베이스 수준에서는 테이블 단위 암호화

## MySQL 서버의 데이터 암호화

- 데이터 베이스 서버와 디스크 사이의 데이터 읽고 쓰기 지점에서 암호화 또는 복호화 수행
- 디스크 입출력 이외의 부분에서는 암호화 처리가 전혀 필요치 않다.
- MySQL 서버 (InnoDB 스토리지 엔진)의 I/O 레이어에서만 데이터의 암호화 및 복호화 과정 실행
- MySQL 사용자는 암호화 기능이 활성화 돼 있어도 아무런 차이가 없다.
    - TDE (Transparent Data Encryption)
    - Data at Rest Encryption
        - Data at Rest 는 메모리 나 네트워크 전송 단계가 아닌 디스크에 저장된(At Rest) 단계에서만 암호화 된다는 뜻


### 2단계 키 관리

- TDE 에서 암호화는 키링 플러그인에 의해 관리
    - keyring_file File-Based 플러그인
    - keyring_encrypted_file Keyring 플러그인
    - keyring_okv KMIP 플러그인
    - keyring_aws Amazon Web Services Keyring 플러그인
    - 내부적으로 동작은 모두 갖다

- 2단계 키 관리 방식
    - 마스터 키
        - 마스터 키를 이용해 테이블스페이스키를 암호화해서 각 테이블의 데이터 파일 헤더에 저장
        - 주기적으로 변경해야 한다.
        - 마스터 키를 변경하면 기존의 마스터 키를 이용해 각 테이블의 테이블스페이스 키를 복호화 한 다음 새로운 마스터 키로 다시 암호화
    - 테이블스페이스 키
        - private key
        - 테이블이 생성될 때마다 생성됨
        - 만약 테이블스페이스키가 바뀌면 해당 테이블의 모든 레코드를 복호화한 후 다시 암호화해야 하기 때문에 테이블스페이스 키는 절대 바뀌지 않음

### 암호화 성능

- Disk 에서 읽을 때에만 복호화 수행
    - 버퍼 풀에 있는 데이터는 암호화 되지 않은 데이터와 동일
    - 복호화 시간 만큼 쿼리 지연됨
    - 또는 디스크에 저장할 때에도 암호화 해야 하므로 추가 시간이 걸림
        - 다만 백그라운드 스레드가 저장을 수행하므로 실제 사용자의 쿼리가 지연되는 것은 아님
- AES 암호화 알고리즘은 암호화 결과가 평문의 결과와 동일한 크기의 암호문을 반환
    - TDE 를 적용한다고 해도 InnoDB 버퍼 풀의 효율이 달라지거나 하지는 않음
- 같은 테이블에 압축과 암호화를 동시에 적용하면 압축 후 암호화
    - 암호화는 랜덤한 바이트의 배열이므로 압축률을 떨어뜨림
    - 압축된 데이터는 압축되거나 압축해제된 두 가지 상태를 가지므로
        - 우선은 복호화 해서 가져온 다음 상태를 결정해야 함

### 암복호화와 복제

- 레플리카 서버는 소스 서버의 모든 사용자 데이터를 동기화 하기 때문에 데이터 파일도 동일할 거라 생각할 수 있다.
    - TDE 암호화 사용 시 마스터 키와 테이블 스페이스 키는 그렇지 않다.
    - 노드마다 마스터 키, 테이블스페이스 키가 다름
    - 따라서 암호화된 데이터가 저장된 파일의 내용은 다르다

## 언두 로그 및 리두 로그 암호화

- 8.0 부터는 리두 로그와 언두 로그를 암호화된 상태로 저장할 수 있게 됐다.
- 리두 로그나 언두 로그를 평문으로 저장하다가 암호화가 활성화되면 그때부터 생성되는 리두, 언두 로그를 암호화해서 저장한다.
- 리두 로그와 언두 로그 데이터는 각각의 테이블스페이스 키로 암호화되고 테이블스페이스 키는 다시 마스터 키로 암호화 된다.
- 리두 로그와 언두 로그를 위한 프라이빗 키는 마스터 키로 암호화 되어 각각 파일의 헤더에 저장된다.