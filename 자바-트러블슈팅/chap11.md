# 스레드 문제

- 스레드 단면으로 확인할 수 있는 문제
  - chap1 참고 : 시스템이 느려요
  - chap1 참고 : 시스템이 응답이 없어요
  - chap1 참고 : 예외가 발생해요
    - 전체 세모
  - 시스템이 죽어요 -> 확인 불가
    - 이때는 확인할 수 없으므로 OnError 옵션으로 유추해야 한다.
    - > -XX:ONError="명령어"
    - > -XX:ErrorFile=파일경로

## 시스템이 느릴 때도 스레드와 관련이 있을까?
- 시스템이 느릴 때에는 다음과 같은 순서로 점검 권장
  1. CPU, 메모리 같은 리소스 사용량 점검
  2. 외부와 연동하는 리소스 사용량 점거
  3. WAS 메모리 및 스레드 설정 및 사용량 점검
  4. Web 서버 설정 점검
  5. OS 설정 점검
  6. 스레드 상태 점검
  7. 메모리 상태 점검
- 여기에서는 스레드에 해당되는 6번에 대해 알아본다
  - APM 으로 프로파일링 하는 것이 가장 좋은 방법
  - 응답 시간이 느려지는 원인 중 대부분은 DB 와 같은 WAS 와 연동되는 외부 서버
  - DB 쿼리가 느린지, DB 서버의 CPU 사용량은 어떤지 DB 에 lock 발생했는지 등 체크

## 시스템 응답이 없을 때에는 스레드 단면이 가장 효과적이다.
- 스레드 단면이 가장 큰 효과를 발휘하는 부분은 -> 시스템 응답이 없는 경우
  - 시스템이 응답하지 않을 때에는 보통 WAS 가 정해 놓은 스레드 풀이나 DB 커넥션 풀이 꽉 찼을 확률이 높다
  - 스레드 단면 30 ~ 1 초 단위로 발생시킨 후 확인
  1. 전체 스레드 개수가 몇 개인지 확인
  2. Java 6 이상일 경우 루트 노드를 클릭하여 메모리 사용량 체크, 여러 단면 파일을 비교해가며 메모리 값이 어떻게 변해가는지 체크
  3. Monitor 목록에서 빨간색으로 표시되어 여러 스레드를 잡는 녀석이 없는지 체크
  4. 1에 해당하는 스레드가 보이지 않을 때에는 Runnable 인 스레드들을 살펴본다
  5. 지속해서 수행 중인 스레드가 존재하지 않는지 체크
  6. 그래도 원인이 없어 보인다면 다른 원인을 확인하자
  - 스레드 실행 중인 상태 -> CPU 코어 하나가 100% 이상 사용 -> 메모리 상태 모니터링

## 예외가 지속해서 발생할 때도 스레드 단면이 도움이 될까?
- Runtime Error
- 스레드 단면으로 많은 결과를 얻기 힘들다
- 가장 좋은 단서는 log
- TimeoutException
  - DB 에서 응답이 늦는지 (query, cpu usage ...)
  - GC 때문인지
  - 연동되어 잇는 시스템에서 응답이 오지 않는지

## CPU Usage 가 높을 때
- 일반적인 상황이면 코어 4개 각 25%
- 하나의 코어가 급증할 때는
  - 무한 루프
  - XML 라이브러리 문제로 특수문자가 들어왔을 때 parsing 을 제대로 못해서 무한 루프
  - 정규 표현식을 잘못 써서 무한 루프
  - GC

## 스레드 풀의 스레드 개수가 계속 증가할 때
- 어떤 요청이 끝나지 않을 때
- 대개는 IO Blocking 의 가능성